name: QA

on:
    push:
        branches:
            - master
    pull_request:
        branches:
            - master

jobs:
    qa:
        name: Code-Quality-Checks
        runs-on: ubuntu-latest
        
        env:
            # PHP package name is equal to the repository name.
            package-name: ${{ github.event.repository.name }}
            gally-directory: ${{ github.workspace }}/gally
            src-directory: ${{ github.workspace }}/${{ github.event.repository.name }}
        
        steps:
            - name: Checkout full repository to be used as a composer repository
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0
                  path: gally-repository

            - name: Checkout Gally template
              uses: actions/checkout@v3
              with:
                  # Checkout gally "template" from the same branch. This is the dev environment with docker files.
                  repository: 'Elastic-Suite/standalone'
                  #ref: ${{ github.base_ref }}
                  ref : master
                  token: ${{ secrets.GH_TOKEN }} # needed only until the gally "template" becomes public.
                  path: ${{ env.gally-directory }}

            # in $GITHUB_WORKSPACE we will have this after this step : 
            # - gally-repository : gally-standard repository to be used as composer repository.
            # - gally : a full development environment which is needed for PHPStan

            - name: Cache Composer dependencies
              uses: actions/cache@v2
              with:
                  path: /tmp/composer-cache
                  key: ${{ runner.os }}-${{ hashFiles('**/composer.lock') }}

            - name: Prepare local Repository
              run: composer config --global --no-interaction --ansi repositories.${{ env.package-name }} git "$GITHUB_WORKSPACE/gally-repository"

            - name: Adding local package from current branch or PR
              working-directory: ${{ env.gally-directory }}
              run: |
                  ls -l
                  cd api
                  ls -l
                  cat $GITHUB_WORKSPACE/gally-repository/composer.json
                  composer require "gally/${{ env.package-name }}:${GITHUB_BASE_REF:-${GITHUB_REF##*/}}-dev" --ignore-platform-reqs

            - uses: php-actions/composer@v6
              with:
                  php_version: "8.1"
                  # working-dir is relative, it's always launched from $GITHUB_WORKSPACE, cannot use gally-directory env var.
                  args: --working-dir gally/api
            
            - name: PHP-CS-Fixer
              working-directory: ${{ env.gally-directory }}
              run: ./vendor/bin/php-cs-fixer fix --path-mode=intersection --diff --dry-run vendor/gally/${{ env.package-name }}

            - name: PHPStan
              working-directory: ${{ env.gally-directory }}
              run: |
                  cd api
                  # do PHPstan with current phpstan.neon.dist file from current branch or PR
                  cp -rf vendor/gally/${{ env.package-name }}/phpstan.neon.dist phpstan.neon.dist                   
                  ./vendor/bin/phpstan analyse vendor/gally/${{ env.package-name }}
