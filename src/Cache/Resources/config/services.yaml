services:
    Gally\Cache\Service\CacheManagerInterface: '@Gally\Cache\Service\CacheManager'
    Gally\Cache\Service\CacheManager:
        arguments:
            - '@gally.cache'
        tags:
            - { name: kernel.cache_clearer }
        
    Gally\Cache\Service\CacheInvalidatorInterface: '@Gally\Cache\Service\CacheInvalidator'
    Gally\Cache\Service\CacheInvalidator:
        arguments:
            - !tagged_iterator kernel.cache_clearer
            - !tagged_iterator cache.taggable
            - '@?ApiPlatform\Core\HttpCache\PurgerInterface'
            - 'kernel.cache_dir'

    ApiPlatform\Core\HttpCache\PurgerInterface: '@api_platform.http_cache.purger.varnish'

    gally.cache:
        parent: cache.app.taggable
        tags:
            - { name: cache.pool }
            - { name: cache.taggable }

    Gally\Cache\EventSubscriber\ResponseSubscriber:
        tags:
            - { name: kernel.event_subscriber }

    Gally\Cache\EventSubscriber\AddProxyCacheTagsSubscriber:
        arguments:
            - '@Gally\Cache\Service\ProxyCacheManager'
        tags:
            - { name: kernel.event_subscriber }

    Gally\Cache\Service\ProxyCacheManager:
        arguments:
            - '@request_stack'
            - '@Gally\ResourceMetadata\Service\ResourceMetadataManager'
            - '@api_platform.metadata.resource.metadata_collection_factory'
            - '@api_platform.iri_converter'

    api_platform.http_cache.tag_collector:
        class: Gally\Cache\Service\TagCollector
        arguments:
            - '@Gally\Configuration\Service\ConfigurationManager'
